---
title: Тестирование API
description: Тестирование RESTful API на PostgREST с Insomnia 
---

import { Aside, LinkCard, CardGrid, Card, Steps } from '@astrojs/starlight/components';

### Цель

На этом этапе тебе предстоит разобраться самому и простыми словами объяснить фронтендерам, по каким адресам и с какими настройками обращаться, чтобы получать или мутировать те или иные данные в таблицах.
Для этого необходимо провести небольшое исследование, изучив документацию `PostgREST` и проверив наши догадки через тестирование специальным клиентом.

### Спецификация API проекта

В нашем случае ресурсами будут: `employees`, `events`, `products`, `orders`

В спецификации обычно описаны действия, которые нам нужно реализовать над ресурсами, и дополнительные параметры

В последних разделах мы предоставим таблицу по всем ресурсам, а пока начнем с ресурса `employees`.

| HTTP-запрос | Ресурс | Параметры | Описание |
|-------------|--------|-----------|----------|
| GET | employees | фильтр, сортировка, пагинация | получить данные о сотрудниках |
| PATCH | employees | фильтр | обновить данные о сотруднике / сотрудниках |

Для проверки работоспособности нашего `API`, который, напомним, уже сгенерировал для нас `Supabase`, 
мы будем использовать `Postman`

### Знакомство с Postman

`Postman` - инструмент для тестирования `API`.

Основные возможности:
- отправка различных типов HTTP-запросов с возможностью настроить параметры запросов, передать заголовки, параметры и тело запроса;
- организация запросов и тестов в коллекции для упрощения управления большим числом запросов; 
- создание тестов для проверки ответов от сервера, использование коллекций для автоматизации тестов или комплексных тестовых сценариев;
- переключение между различными конфигурациями окружения (например, тестовое, разработка, продакшн);
- возможность использования открытых и секретных переменных, для переиспользования в запросах, тестах и окружениях.

Есть разные способы использования `Postman`:
- настольное приложение,
- расширения для редакторов кода,
- веб-версия (предлагаем использовать её, примеры будут на ней). 

Выполни подготовительные шаги:

<Steps>
1. Зарегистрируйся на [postman.com](https://www.postman.com/)
2. Создай `Workspace`:
    - `Workspaces -> Create Workspace`
    - выбери шаблон `Blank workspace`, 
    - введи название по твоему выбору, 
    - выбери доступы `Only me` или `Everyone from team`  
3.  Попав в созданный `Workspace`, создай первую коллекцию: 
    - клик по кнопке `Create Collection`, 
    - введи название по твоему выбору
4. Настроим переменные для переиспользования:
    - находясь в коллекции, перейди на вкладку `Variables`   
    - создай переменную `BASE_URL`, в качестве значений возьми `Project URL` с `Supabase` 
    - создай переменную `VERSION`, в качестве значения введи `rest/v1`
    - создай переменную `API_KEY`, в качестве значения возьми `API Key [public]` с `Supabase`
    - сохрани изменения по `ctrl + s`
5. Настроим авторизацию:
    - перейди на вкладку `Authorization`
    - выбери тип `API Key`
    - задай `Key` равным `apikey`
    - задай `Value` равным `{{API_KEY}}`
    - сохрани изменения по `ctrl + s`
</Steps>

<LinkCard title="Знакомство с Postman от Vk" href="https://habr.com/ru/companies/vk/articles/750096/"></LinkCard>

### Тестирование API с Postman

Для старта предлагаем посмотреть видео:

https://screenrec.com/share/HUlTs8VRvk

##### Получение списка всех сотрудников

Пример ответа на `GET /employees`:
```json
[
    {
        "id": 2,
        "created_at": "2024-03-07T21:16:27.268424+00:00",
        "first_name": "Максим",
        "last_name": "Росинка",
        "account_id": "f7bdebe0-5bcc-4f13-b0a6-6564ab6ba16c",
        "points": 0,
        "position": "middle frontend developer",
        "avatar": "https://i.pravatar.cc/150?img=18"
    },
    {
        "id": 1,
        "created_at": "2024-03-07T21:16:06.68388+00:00",
        "first_name": "Мариан",
        "last_name": "Степанова",
        "account_id": "e7e40bc8-1fc4-4c69-b6fc-ecb2a177ff20",
        "points": 10,
        "position": "hr lead",
        "avatar": "https://i.pravatar.cc/150?img=48"
    }
]
```

Сейчас ответ выглядит хорошо, но по мере роста объема данных такой запрос может стать  непрактичным - 
возвращаются все имеющиеся данные, даже тогда, когда мы хотим получить информацию о конкретном сотруднике 
или всех сотрудниках с грейдом lead. 

##### Получение сотрудников с фильтрацией

Для указания дополнительных параметров запросов в `REST` можно использовать строки запроса `query string`. 
Имена параметров - это колонки таблиц, а возможные значения параметров определяются сервером `PostgREST` 

Так, для фильтрации мы указываем колонку, по которой хотим фильтровать, и правило фильтрации. 
Можно включать и несколько параметров запроса, перечисляя их через `&`

Например: 
- `GET /employees?id=eq.2` вернет данные по сотруднику с идентификатором `2`
    ```json
    [{
        "id": 2,
        "created_at": "2024-03-07T21:16:27.268424+00:00",
        "first_name": "Максим",
        "last_name": "Росинка",
        "account_id": "f7bdebe0-5bcc-4f13-b0a6-6564ab6ba16c",
        "points": 0,
        "position": "middle frontend developer",
        "avatar": "https://i.pravatar.cc/150?img=18"
    }]
    ```
- `GET /employees?position=like.*lead*&points=neq.0` вернет сотрудников с грейдом `lead` и ненулевой внутренней валютой
    ```json
    [{
        "id": 1,
        "created_at": "2024-03-07T21:16:06.68388+00:00",
        "first_name": "Мариан",
        "last_name": "Степанова",
        "account_id": "e7e40bc8-1fc4-4c69-b6fc-ecb2a177ff20",
        "points": 10,
        "position": "hr lead",
        "avatar": "https://i.pravatar.cc/150?img=48"
    }]
    ```

##### Получение сотрудников с пагинацией

Второе применение строки запроса, которое нам пригодится — ограничение количества возвращаемых данных (пагинация), которое позволяет снизить объем пересылаемых данных и улучшить пользовательский опыт. 

Так, запрос `GET /employees?offset=10&limit=5` вернет нам 11-15 сотрудников (третью страницу).

##### Получение сотрудников с сортировкой

В `PostgREST` сортировкой управляет параметр `order`, а значением может определять одно или несколько правил:

- `GET /employees?order=created_at` отсортирует сотрудников по дате регистрации (от самого раннего времени трудоустройства к тем, кто трудоустроен недавно)
    ```json
    [
    {
        "id": 1,
        "created_at": "2024-03-07T21:16:06.68388+00:00",
        "first_name": "Мариан",
        "last_name": "Степанова",
        "account_id": "e7e40bc8-1fc4-4c69-b6fc-ecb2a177ff20",
        "points": 0,
        "position": "hr lead",
        "avatar": "https://i.pravatar.cc/150?img=48"
    },
    {
        "id": 2,
        "created_at": "2024-03-07T21:16:27.268424+00:00",
        "first_name": "Максим",
        "last_name": "Росинка",
        "account_id": "f7bdebe0-5bcc-4f13-b0a6-6564ab6ba16c",
        "points": 0,
        "position": "middle frontend developer",
        "avatar": "https://i.pravatar.cc/150?img=18"
    },
    {
        "id": 3,
        "created_at": "2024-03-07T21:42:22.002204+00:00",
        "first_name": "Кирилл",
        "last_name": "Мышкин",
        "account_id": "04e1a619-255a-4e69-b9c1-df1d43387c55",
        "points": 0,
        "position": "senior mobile developer",
        "avatar": "https://www.kindpng.com/picc/m/421-4212275_transparent-default-avatar-png-avatar-img-png-download.png"
    },
    {
        "id": 4,
        "created_at": "2024-03-07T21:42:42.357922+00:00",
        "first_name": "Виктория",
        "last_name": "Чудская",
        "account_id": "91f7ad9e-eab1-4cad-b983-462f280cdbeb",
        "points": 0,
        "position": "middle QA engineer",
        "avatar": "https://i.pravatar.cc/150?img=66"
    }]```
- `GET /events?order=date_start.asc,date_end.desc` отсортирует события по времени начала (от самого ближайшего к самому отдаленному), 
    а при совпадении времени - дополнительно по времени окончания (от самого продолжительного к самому короткому).

##### Получение сотрудников с комбинированием параметров

Описанные выше параметры можно объединять: например, отфильтровать всех сотрудников разработки со стажем менее 2 лет, отсортировать по дате регистрации и вывести первые 10 записей.

`GET /employees?created_at=gte."2022-04-01"&position=like.*dev*&order=created_at.desc&limit=10`

```json
[
    {
        "id": 3,
        "created_at": "2024-03-07T21:42:22.002204+00:00",
        "first_name": "Кирилл",
        "last_name": "Мышкин",
        "account_id": "04e1a619-255a-4e69-b9c1-df1d43387c55",
        "points": 0,
        "position": "senior mobile developer",
        "avatar": "https://www.kindpng.com/picc/m/421-4212275_transparent-default-avatar-png-avatar-img-png-download.png"
    },
    {
        "id": 2,
        "created_at": "2024-03-07T21:16:27.268424+00:00",
        "first_name": "Максим",
        "last_name": "Росинка",
        "account_id": "f7bdebe0-5bcc-4f13-b0a6-6564ab6ba16c",
        "points": 0,
        "position": "middle frontend developer",
        "avatar": "https://i.pravatar.cc/150?img=18"
    }
]
```
##### Модификация сотрудников

Для модификации данных в таблицах мы используем метод `PATCH` и передаем изменяемые колонки в `body` запроса. Чтобы модифицировать не все строки, необходимо задать фильтр. 

Пример запроса на изменение с фильтром по `id`: `PATCH /employees?id=eq.2`

Пример тела запроса:
```json
{
    "first_name": "Александр"
}
```

Видео: https://screenrec.com/share/VH9fKeqICG

### Что дальше

<Aside type="tip" title="Передай фронтендерам">
Бэкенд уже настроил первых пользователей системы. Фронтенд уже может использовать запрос `GET /employees` для запроса информации по сотрудникам. Помимо этого для любого запроса требуется базовый адрес и настройки доступа. Если вы не передали информацию об `URL` и `API KEY`, сделайте это сейчас.
</Aside>


### Что еще почитать по теме

- [Документация PostgREST](https://postgrest.org/en/v12/)
- [Статья о Postman на Хабре](https://habr.com/ru/articles/754154/)